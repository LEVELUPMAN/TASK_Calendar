// --- Apps Script (Code.gs) ---
const SHARED_TOKEN = 'YOUR_SECRET_TOKEN';  // フロントと共有する簡易トークン
const CALENDAR_ID  = 'primary';            // 既定カレンダー

function doPost(e) {
  try {
    const body = JSON.parse(e.postData.contents);
    if (body.token !== SHARED_TOKEN) return ContentService.createTextOutput('forbidden').setMimeType(ContentService.MimeType.TEXT);
    const action = body.action;
    if (action === 'create') {
      const ev = body.event; // {date, title, text, when, color}
      const cal = CalendarApp.getCalendarById(CALENDAR_ID);
      let start = ev.when ? new Date(ev.when) : new Date(ev.date + 'T09:00:00');
      let end   = new Date(start.getTime() + 30*60*1000);
      cal.createEvent(`${ev.title}：${ev.text}`, start, end, {description: 'from TaskCalendar v7'});
      return json({ok:true});
    }
    return json({ok:false, error:'unknown action'});
  } catch (err) {
    return json({ok:false, error:String(err)});
  }
}

function doGet(e){
  try{
    const p = e.parameter;
    if (p.token !== SHARED_TOKEN) return json({ok:false, error:'forbidden'});
    if (p.action === 'list'){
      const since = new Date(p.since);
      const until = new Date(p.until);
      const cal = CalendarApp.getCalendarById(CALENDAR_ID);
      const events = cal.getEvents(since, until);
      const out = events.map(ev=>{
        const start = ev.getStartTime();
        const dateKey = Utilities.formatDate(start, Session.getScriptTimeZone(), 'yyyy-MM-dd');
        const whenISO = Utilities.formatDate(start, Session.getScriptTimeZone(), "yyyy-MM-dd'T'HH:mm");
        return {date: dateKey, title: ev.getTitle().split('：')[0], text: ev.getTitle().split('：')[1] || ev.getTitle(), when: whenISO};
      });
      return json(out);
    }
    return json({ok:false, error:'unknown action'});
  }catch(err){
    return json({ok:false, error:String(err)});
  }
}

function json(obj){
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}

